<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{common/layouts/default_layout}"
	  layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<style>
	.action-buttons button {
	    margin-right: 10px;
	}
	
	.content-container {
	    border: 1px solid grey;
	    width: 100%;
		max-width: 1000px;
		max-height: 1000px;
		padding: 20px;
	}
	
	.image-preview {
	    max-width: 100%;
	    max-height: 400px;
	    object-fit: cover;
	    border-radius: 8px;
	}
	
	/* 전체 컨테이너 스타일 */
	.like-comment {
	    display: flex;
	    align-items: center;
	    gap: 15px;
	}
	
	/* 버튼 기본 스타일 */
	.like-comment button {
	    border: none;
	    background: none;
	    cursor: pointer;
	}
	
	/* 카운트 텍스트 스타일 */
	.like-comment .likes-count,
	.like-comment .comments-count {
	    margin-left: 5px;
	    font-size: 1rem; /* 필요에 따라 조정 가능 */
	}
	
	/* 하트 아이콘 기본 색상 */
	.bi-heart {
	    color: pink; /* 기본 하트 색상 */
	}
	
	/* 하트 아이콘이 채워졌을 때 색상 */
	.bi-heart-fill {
	    color: hotpink; /* 채워진 하트 색상 */
	}

    .comment-section {
        margin-top: 20px;
    }

    .comment-input {
        margin-bottom: 10px;
    }

    .comment-submit-btn {
        width: 100px;
    }

    .comment-list {
        margin-bottom: 20px;
    }

    .comment-item {
        border-bottom: 1px solid #ddd;
        padding: 10px 0;
    }

    .comment-item:last-child {
        border-bottom: none;
    }

    .comment-item .comment-author {
        font-weight: bold;
    }

    .comment-item .comment-text {
        margin-top: 5px;
    }
</style>
</head>
<body>
	<div class="container-fluid content-container">
		<div class="container">
			<h3>인증 글 상세 화면</h3>
			<!-- Profile and Actions -->
			<div class="row mb-4">
				<div class="col-lg-12 d-flex align-items-center">
					<div>
						<input type="hidden" th:value="${myConfirm.challNo}" id="cNo">
						<input type="hidden" th:value="${myConfirm.confirmNo}" id="fNo">
						<h4 class="mb-1" th:text="${myConfirm.nickname}"></h4>
						<small class="text-muted"
							th:text="${#dates.format(myConfirm.confirmCreateAt, 'yyyy-MM-dd HH:mm:ss')}"></small>
					</div>
					<div class="ms-auto action-buttons">
						<button type="button" class="btn btn-danger btn-sm" id="delBtn" th:if="${myConfirm.userNo == nowUserNo}">Delete</button>
					</div>
				</div>
			</div>
			<!-- Image Preview -->
			<th:block th:each="file : ${list}">
				<div class="row mb-4">
					<div class="col-lg-12">
						<div class="position-relative h-100">
							<img class="image-preview"
								th:src="@{/images/{filePath}(filePath=${file.filePath})}"
								alt="confirm Images">
						</div>
					</div>
				</div>
			</th:block>
			<!-- Confirm Content -->
			<div class="row mb-4">
				<div class="col-lg-12">
					<div class="border p-4 bg-light rounded">
						<p class="mb-0" th:text="${myConfirm.confirmContent}"></p>
					</div>
				</div>
			</div>
			<!-- Like and Comment Section -->
			<div class="row like-comment">
				<div class="col-lg-12">
					<div class="d-flex align-items-center">
						<button id="likeButton" class="btn btn-outline-primary">
							<i id="likeIcon" class="bi bi-heart"></i>
						</button>
						<span class="likes-count" th:text="${myConfirm.cntLike} + ' Likes'"></span>
						<button class="btn btn-outline-secondary ms-3">
							<i class="bi bi-chat-dots"></i>
						</button>
						<span class="comments-count" th:text="${myConfirm.cntReply} + ' Comments'"></span>
					</div>
				</div>
			</div>
			<div class="row comment-section" id="reply">
                <!-- reply.html -->
            </div>
		</div>
	</div>

	<!-- Bootstrap JavaScript and Icons -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.js"></script>
    <script>
    	let fNo = $('#fNo').val();
    	let cNo = $('#cNo').val();
    	
    	//댓글 부분 html로 따로 빼서 load()
    	replyList();
    	function replyList() {
   	        $('#reply').load('replyList?confirmNo=' + fNo);
   	        
    	}
    	
    	//댓글 등록
    	$(document).on('click', '#replyBtn', function() {
    	    let replyContent = $('#confirmReplyContent').val();
    	    $.ajax({
    	        url: 'replyInsert',
    	        type: 'post',
    	        data: {
    	            confirmNo: fNo,
    	            confirmReplyContent: replyContent
    	        },
    	        success: function(result) {
    	            alert('댓글이 등록되었습니다.');
    	            console.log(result);
    	            //댓글 등록 후 댓글 목록 호출
    	            replyList();
    	        },
    	        error: function(err) {
    	            console.log(err);
    	        }
    	    });
    	});
    	
    	//댓글 삭제
    	$(document).on('click', '.deleteBtn', function() {
    		let replyNo = $(this).data('replyno');
    		console.log(replyNo);
    		$.ajax({
    			url : 'replyDelete',
    			type : 'post',
    			data : {
    				confirmReplyNo : replyNo
    			},
    			success : function(result){
    				if(result == 1){
    					alert('댓글이 삭제되었습니다.');
	    				replyList();
    				}else{
    					alert('삭제되지 않았습니다.');
    				}
    			},
    			error : function(err){
    				console.log(err);
    			}
    		})
    	})
    	
    	//인증 글 삭제
    	$('#delBtn').on('click', function(){
    		if(confirm('해당 인증 글을 삭제하겠습니까?')){
	    		$.ajax({
	    			url : 'confirmDelete',
	    			type : 'post',
	    			data: {
	    	            confirmNo: fNo
	    	        },
	    			success : function(result){
	    				if(result){
		    				alert('인증 글이 삭제되었습니다.');
		    				console.log(result);
		    				location.href = 'detail?challNo=' + cNo;
	    				}else{
	    					alert('삭제 권한이 없습니다.');
	    				}
	    			},
	    			error : function(err){
	    				console.log(err);
	    			}
	    		})
    		}
    	})
    	
    	//좋아요 했는지 안했는지 우선 체크
    	$(document).ready(function(){
    		let likeIcon = $('#likeIcon');
    		$.ajax({
    			url : 'confirmLikeStatus',
    			type : 'get',
    			data : {
    				confirmNo: fNo
    			},
    			success : function(status){
    				console.log(status);
    				console.log(likeIcon);
    				if(status == 1){ //좋아요 했는 상태
	    				likeIcon.removeClass('bi bi-heart');
    					likeIcon.addClass('bi bi-heart-fill');   
    				}
    			},
    			error : function(err){
    				console.log(err);
    			}
    		})
    		
    		//좋아요 등록
	    	$('#likeButton').click(function(){
	            $.ajax({
	            	url : 'confirmLikeInsert?confirmNo=' + fNo,
	            	type : 'post',
	            	data : {
	                    confirmNo: fNo
	                },
	            	success : function(result) {
	                    if (result.likeStatus == 1) { //좋아요 등록/삭제
	                        likeIcon.toggleClass('bi-heart bi-heart-fill');
	                        $('.likes-count').text(result.totalCnt + ' Likes');
	                    } else {
	                        alert('처리 오류');
	                    } 
	                    console.log(result);
	                },
	                error: function(err) {
	                    console.log(err);
	                }
	            })
	    	})
    		
    	})
    </script>
</body>
</html>