<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{common/layouts/default_layout}"
	  layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<style>
	.action-buttons button {
	    margin-right: 10px;
	}
	
	.content-container {
	    border: 1px solid grey;
	    width: 100%;
		max-width: 1000px;
		padding: 20px;
	}
	
	.image-preview {
	    max-width: 100%;
	    max-height: 400px;
	    object-fit: cover;
	    border-radius: 8px;
	}
	
	.like-comment {
	    display: flex;
	    align-items: center;
	    gap: 15px;
	}
	
	.like-comment button {
	    border: none;
        background: none;
        cursor: pointer;
        display: flex;
        align-items: center;
	}
	
	.like-comment i {
        font-size: 1.2rem; /* 아이콘 크기 조절 */
        margin-right: 5px;
        
    }
	
	.like-comment .likes-count,
	.like-comment .comments-count {
	    margin-left: 5px;
	    font-size: 1rem; /* 필요에 따라 조정 가능 */
	}
	
	/* 하트 아이콘 기본 색상 */
	.bi-heart {
	    color: pink; /* 기본 하트 색상 */
	}
	
	/* 하트 아이콘이 채워졌을 때 색상 */
	.bi-heart-fill {
	    color: hotpink; /* 채워진 하트 색상 */
	}

    .comment-section {
        margin-top: 20px;
    }

    .comment-input {
        margin-bottom: 10px;
    }

    .comment-submit-btn {
        width: 100px;
    }

    .comment-list {
        margin-bottom: 20px;
    }

    .comment-item {
        border-bottom: 1px solid #ddd;
        padding: 10px 0;
    }

    .comment-item:last-child {
        border-bottom: none;
    }

    .comment-item .comment-author {
        font-weight: bold;
    }

    .comment-item .comment-text {
        margin-top: 5px;
    }
    .report-button {
        color: #9B9B9B;
        cursor: pointer;
        display: flex;
        align-items: center;
    }

    .report-button i {
        margin-right: 5px;
        font-size: 1.2rem;
    }
    /*모달*/
	.modal {
		display: none;
	    position: fixed;
	    z-index: 1000;
	    left: 0;
	    top: 0;
	    width: 100%;
	    height: 100%;
	    overflow: auto;
	    background-color: rgba(0, 0, 0, 0.5); 
	}
	   
	.modal_body {
		background-color: #ffffff;
	    margin: 15% auto;
	    padding: 20px;
	    border-radius: 10px;
	    width: 400px;
	    color: #333; 
	    text-align: center;
	    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
	}
	
	.testimonial-carousel .testimonial-img img {
	    width: 300px;
	    height: 300px;
	}
   .testimonial-carousel .owl-nav {
         top:120px;
	}
	
	.testimonial-carousel:hover .owl-nav {
	    width: 300px;
	}
</style>
</head>
<body>
	<div class="container-fluid content-container">
		<div class="container">
			<h3>인증 글 상세 화면</h3>
			<!-- Profile and Actions -->
			<div class="row mb-4">
				<div class="col-lg-12 d-flex align-items-center">
					<div>
						<input type="hidden" th:value="${myConfirm.challNo}" id="cNo">
						<input type="hidden" th:value="${myConfirm.confirmNo}" id="fNo">
						<input type="hidden" th:value="${myConfirm.userNo}" id="uNo">
						<h4 class="mb-1" th:text="${myConfirm.nickname}"></h4>
						<small class="text-muted"
							th:text="${#dates.format(myConfirm.confirmCreateAt, 'yyyy-MM-dd HH:mm:ss')}"></small>
					</div>
					<div class="ms-auto action-buttons">
						<button type="button" class="btn btn-danger btn-sm" id="delBtn" th:if="${myConfirm.userNo == nowUserNo}">Delete</button>
					</div>
				</div>
			</div>
			            
		    <!-- Testimonial Start -->
			<div class="container-xxl py-5">
				<div class="container">
					<div class="owl-carousel testimonial-carousel wow fadeInUp"
						data-wow-delay="0.1s">
						<th:block th:each="file, sts : ${list}">
							<div class="testimonial-item text-center">
								<div class="testimonial-img position-relative">
									<img class="img-fluid mx-auto mb-5"
										th:src=@{/images/{filePath}(filePath=${file.filePath})}
										alt="인증 이미지">
								</div>
							</div>
						</th:block>
					</div>
				</div>
			</div>
			<!-- Testimonial End -->
			
 			<!-- Image Preview 기존거 -->
<!--/*			<th:block th:each="file : ${list}">
				<div class="row mb-4">
					<div class="col-lg-12">
						<div class="position-relative h-100">
							<img class="image-preview"
								th:src="@{/images/{filePath}(filePath=${file.filePath})}"
								alt="confirm Images">
						</div>
					</div>
				</div>
			</th:block> */-->
			<!-- Confirm Content -->
			<div class="row mb-4">
				<div class="col-lg-12">
					<div class="border p-4 bg-light rounded">
						<p class="mb-0" th:text="${myConfirm.confirmContent}"></p>
					</div>
				</div>
			</div>
			<!-- Like and Comment Section -->
			<div class="row like-comment">
				<div class="col-lg-12">
					<div class="d-flex align-items-center">
						<button id="likeButton" class="btn btn-outline-primary">
							<i id="likeIcon" class="bi bi-heart"></i>
						</button>
						<span class="likes-count" th:text="${myConfirm.cntLike} + ' Likes'"></span>
						<button class="btn btn-outline-secondary ms-3">
							<i class="bi bi-chat-dots"></i>
						</button>
						<span class="comments-count" th:text="${myConfirm.cntReply} + ' Comments'"></span>
			            <button class="btn btn-outline-success ms-3">
			                <i class="bi bi-share"></i>
			            </button>
		                <span class="ms-1">Share</span>
			            <button class="btn btn-outline-danger ms-auto" id="declareModal" th:onclick="declareModal('confirm', [[${myConfirm.confirmNo}]])" th:if="${myConfirm.userNo != nowUserNo}">
			                <i class="bi bi-exclamation-triangle"></i>
			            </button>
		                <span class="ms-1" th:if="${myConfirm.userNo != nowUserNo}">Report</span>
					</div>
				</div>
			</div>
			<div class="row comment-section" id="reply">
                <!-- reply.html -->
            </div>
		</div>
	</div>
	<!-- 모달영역 -->
 	<div class="modal">
        <div class="modal_body">
			<div class="inputleft">
				<h4>신고하기</h4>
				<hr style="width: 100%; height: 5px; border: none;" />
				<form method="post">
					<th:block th:each="declare, sts : ${confirmDeclare}">
						<input name="aaa" type='radio' class='radioBtn'
							th:value="${declare.codeId}" th:id="${declare.codeId}" />
						<label th:text="${declare.codeName}" th:for="${declare.codeId}"></label>
						<hr style="margin: 0px;" />
					</th:block>
				</form>
			</div>
			<button onclick='getDeclare()' class="btn btn-primary" id="btn-declare" aria-label="Close">신고하기</button>
	        <button type="button"  class="btn btn-primary" id="btn-close" aria-label="Close">닫기</button>
        </div>
    </div>
    <script>
    	let fNo = $('#fNo').val();
    	let cNo = $('#cNo').val();
    	let uNo = $('#uNo').val();
    	
    	//댓글 부분 html로 따로 빼서 load()
    	replyList();
    	function replyList() {
   	        $('#reply').load('replyList?confirmNo=' + fNo);
   	        
    	}
    	
    	//댓글 등록
    	$(document).on('click', '#replyBtn', function() {
    	    let replyContent = $('#confirmReplyContent').val();
    	    $.ajax({
    	        url: 'replyInsert',
    	        type: 'post',
    	        data: {
    	            confirmNo: fNo,
    	            confirmReplyContent: replyContent
    	        },
    	        success: function(result) {
    	            alert('댓글이 등록되었습니다.');
    	            console.log(result);
    	            //댓글 등록 후 댓글 목록 호출
    	            replyList();
    	            //$('.comments-count').text(totalCnt + ' Comments');
    	            //댓글창 비우기
    	            $('#confirmReplyContent').val('');
    	        },
    	        error: function(err) {
    	            console.log(err);
    	        }
    	    });
    	});
    	
    	//댓글 삭제
    	$(document).on('click', '.deleteBtn', function() {
    		let replyNo = $(this).data('replyno');
    		console.log(replyNo);
    		$.ajax({
    			url : 'replyDelete',
    			type : 'post',
    			data : {
    				confirmReplyNo : replyNo
    			},
    			success : function(result){
    				if(result == 1){
    					alert('댓글이 삭제되었습니다.');
	    				replyList();
    				}else{
    					alert('삭제되지 않았습니다.');
    				}
    			},
    			error : function(err){
    				console.log(err);
    			}
    		})
    	})
    	
    	//인증 글 삭제
    	$('#delBtn').on('click', function(){
    		if(confirm('해당 인증 글을 삭제하겠습니까?')){
	    		$.ajax({
	    			url : 'confirmDelete',
	    			type : 'post',
	    			data: {
	    	            confirmNo: fNo
	    	        },
	    			success : function(result){
	    				if(result){
		    				alert('인증 글이 삭제되었습니다.');
		    				console.log(result);
		    				location.href = 'detail?challNo=' + cNo;
	    				}else{
	    					alert('삭제 권한이 없습니다.');
	    				}
	    			},
	    			error : function(err){
	    				console.log(err);
	    			}
	    		})
    		}
    	})
    	
    	//좋아요 했는지 안했는지 우선 체크
    	$(document).ready(function(){
    		let likeIcon = $('#likeIcon');
    		$.ajax({
    			url : 'confirmLikeStatus',
    			type : 'get',
    			data : {
    				confirmNo: fNo
    			},
    			success : function(status){
    				console.log(status);
    				console.log(likeIcon);
    				if(status == 1){ //좋아요 했는 상태
	    				likeIcon.removeClass('bi bi-heart');
    					likeIcon.addClass('bi bi-heart-fill');   
    				}
    			},
    			error : function(err){
    				console.log(err);
    			}
    		})
    		
    		//좋아요 등록
	    	$('#likeButton').click(function(){
	            $.ajax({
	            	url : 'confirmLikeInsert?confirmNo=' + fNo,
	            	type : 'post',
	            	data : {
	                    confirmNo: fNo
	                },
	            	success : function(result) {
	                    if (result.likeStatus == 1) { //좋아요 등록/삭제
	                        likeIcon.toggleClass('bi-heart bi-heart-fill');
	                        $('.likes-count').text(result.totalCnt + ' Likes');
	                        
	                        if (typeof sendAlarm === "function") {
	    	                    sendAlarm('H2', fNo);
	    	                } else {
	    	                    console.error("sendAlarm 함수가 정의되지 않았습니다.");
	    	                }
	                    } else {
	                        alert('처리 오류');
	                    } 
	                    console.log(result);
	                },
	                error: function(err) {
	                    console.log(err);
	                }
	            })
	    	})
    	})
    	
    	//신고하기 모달창
    	function declareModal(state, stateNo){
			event.preventDefault();
			
			modal.style.display="block";
			//console.log(state);
			if(state == 'confirm'){
				 fNo = stateNo;
			}
		}
    	
    	//모달
    	const modal = document.querySelector('.modal');

    	$('#btn-close').on('click', function(){
    		 modal.style.display="none";
    	});
    	
    	//신고하기 등록
    	let declareId = JSON.parse(/*[[${confirmDeclareJson}]]*/ '[]');
    	//let userNo = /*[[${session.userNo}]]*/ 0;
    	
    	function getDeclare() {
    		let codeId = "";
    		console.log('declareId=', declareId);
    		console.log('confirmNo=', fNo);
    		$('.radioBtn').each(function(){
    		  if($(this).is(":checked")){
    			    codeId=$(this).val();
    				console.log($(this).val());
    		  }
    	    });
    		
    		$.ajax({
    			url : "confirmDeclareInsert",
    			type : "post",
    			data : {
    				confirmNo: fNo,
    				codeId: codeId,
    			},
    			success : function(list){
    				 alert("해당 인증 글이 신고되었습니다.");
    				 location.href = 'othersInfo?confirmNo=' + fNo + '&userNo=' + uNo;
    			},
    			error :  function(err){
    				alert("신고 처리 중 오류");
    				console.log(err);
    			}
    		});
    	}
    </script>
</body>
</html>