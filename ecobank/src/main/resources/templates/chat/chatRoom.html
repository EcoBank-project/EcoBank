<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>채팅</title>
<link rel="stylesheet" href="../css/chatRoom/chat.css" />
<script src="https://cdn.jsdelivr.net/sockjs/1/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>
    <h3>채팅</h3>
    <div class="container-fluid">
    	<div class="row">
            <div class="col-md-2 col-sm-12">
                <div class="row">
	                <!-- 아이콘 -->
	                <div class="col-md-2 col-sm-12 d-flex flex-column align-items-center">
	                    <a href="#">
	                    	<i class="bi bi-chat"></i>
	                    </a>
	                    <a href="#">
	                    	<i class="bi bi-plus-circle"></i>
	                    </a>
	                    <a href="#">S3</a>
	                </div>
	                <!-- 채팅방 목록 -->
			        <div class="chatRoom-list col-md-10 col-sm-12 d-flex flex-column">
			        	<input type="text" class="chat-room-search" placeholder="채팅방 검색">
			        	<div>다이렉트 메시지</div>
			            <ul class="chat-room-list private flex-grow-1">
			                <li th:each="room : ${chatRooms}" th:if="${room.chatType} == 'O1'">
			                	<!-- <img src="https://via.placeholder.com/40" class="profil_img"> -->
			                    <a href="#" th:text="${room.chatName}" th:onclick="enterRoom(event, [[${room.chatNo}]], [[${room.chatType}]])"></a>
			                    <i class="fa fa-sign-out-alt" th:onclick="leaveRoom([[${room.chatNo}]])"></i>
			                </li>
			            </ul>
			            <div>그룹 메시지</div>
			            <ul class="chat-room-list group flex-grow-2">
			            	<li th:each="room : ${chatRooms}" th:if="${room.chatType} == 'O2'">
			                    <a href="#" th:text="${room.chatName}" th:onclick="enterRoom(event, [[${room.chatNo}]], [[${room.chatType}]])"></a>
			                    <i class="bi bi-gear"></i>			                    		                
			                    <i class="fa fa-sign-out-alt" th:onclick="leaveRoom([[${room.chatNo}]])"></i>
			                </li>
			            </ul>
			            <!-- 유저 정보 -->
			            <div class="user-info d-flex align-items-center">
			                <img src="https://via.placeholder.com/40" class="profil_img">
			                <div class="user-details">
			                    <div class="user-name">[[${nickname}]]</div>
			                    <div class="user-status">KR</div>
			                </div>
			                <div class="user-actions">
			                    <i class="bi bi-gear"></i>
			                </div>
			            </div>
			        </div>   
                </div>
            </div>

            <!-- 채팅 -->
            <div class="col-md-10 col-sm-12 d-flex flex-column">
            	<div class="row">            	
	                <div>
	                    <h3 id="roomName">채팅창 제목</h3>
	                </div>
            	</div>
                <div class="row">
                	<div class="col-md-10 col-sm-12">
		                <div class="chatForm flex-grow-1 border-bottom" id="chatForm" style="overflow-y: auto;">
		                <!-- 메시지 로그 -->
                            <div class="chatbox" id="chatbox">
		
                            </div>
		                </div>
		                <!-- 메시지 입력 -->
		                <div class="input-group mt-3">
		                    <input type="text" class="form-control" placeholder="메시지..." id="message" th:onkeydown="enterKeyDown(event, [[${userNo}]])">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" th:onclick="sendMessage([[${userNo}]])">보내기</button>
                            </div>                	
                	    </div>
                    </div>
                    <!-- 유저 -->
                    <div class="col-md-2 col-sm-12">
                		<!-- 세션을 이용-->
                        <h5>접속중인 유저</h5>
                        <div>
                            <div>User1</div>
                            <div>User2</div>
                            <div>User3</div>
                        </div>
                        <!-- DB를 이용 -->
                        <h5>오프라인 유저</h5>
                        <div>
                            <div>User1</div>
                            <div>User2</div>
                            <div>User3</div>
                        </div>
                	</div>
                </div>
            </div>
            
        </div>
    </div>
    <!-- 채팅방 만들기 모달-->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>채팅방 만들기</h2>
            <div class="modal-options">
                <div class="option-card">
                    <button id="privateChat" class="option-button">1대1 채팅</button>
                </div>
                <div class="option-card">
                    <button id="groupChat" class="option-button">그룹 채팅</button>
                </div>
            </div>     
		</div>
    </div>
    
	<div id="privateChatModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>1대1 채팅 만들기</h2>
            <input type="text" placeholder="사용자명 입력" class="input-field">
            <h4>팔로우 목록</h4>
            <div id="followListPrivate">

            </div>
            <button class="option-button" id="followPrivateBtn">채팅 만들기</button>
        </div>
    </div>
    
    <div id="groupChatModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>그룹 채팅 만들기</h2>
            <input type="text" placeholder="그룹 채팅방 이름 입력" class="input-field" id="groupChatname">
            <input type="text" id="inviteUsernames" placeholder="초대할 사용자명 입력" class="input-field">
            <h4>팔로우 목록</h4>
            <div id="followListGroup">
                
            </div>
            <button class="option-button" id="followGroupBtn">그룹 채팅 만들기</button>
        </div>
    </div>
    
<script type="text/javascript">
	var stompClient = null;			// stomp 프로토콜
	var currentRoomId = null;		// 방번호
	var chatRoomType = null;		// 채팅방 타입
	const userNo = "[[${userNo}]]"; // 세션정보
	// 소켓 연결
	function connect(roomId,roomType) {
		var socket = new SockJS('/ws');
		stompClient = Stomp.over(socket);
	    stompClient.connect({}, function(frame) {
			
	    	if("O1" === roomType){
			    // 1대1 채팅
			    stompClient.subscribe('/user/queue/messages/' + roomId, function(message) {
			    	showMessage(JSON.parse(message.body));
			    });
	    	}else if("O2" === roomType){
			    // 그룹채팅
		        stompClient.subscribe('/topic/messages/' + roomId, function(message) {
		            showMessage(JSON.parse(message.body));	     
		        });	    		
	    	}
		    
			// 채팅방 목록 로드
	        stompClient.subscribe('/user/queue/chatList', function(message) {
	        	console.log(message);
	        	loadRoom();
	        });
			
			// 채팅방 입장
			
			// 채팅방 퇴장
	    });
	}
	
	// 메시지 엔터키
	function enterKeyDown(event, userNo){
		if(event.key === 'Enter'){
			event.preventDefault();
			sendMessage(userNo);
		}
	}
	
	
	// 채팅방 - 메시지 입력 - 보내기
	function sendMessage(userNo) {
	    let input = document.getElementById("message");
	    let today = new Date(); 
	    const chatMessage = {
	        userNo: userNo,
	        chatNo: currentRoomId,
	        msgContent: input.value,
	        msgType: 'CHAR',
	        msgSendTime: today,
	        nickName: "[[${nickname}]]",
	    };
	    stompClient.send("/app/chat.message/" + currentRoomId, {}, JSON.stringify(chatMessage));
	    input.value = "";
	}
	
	// 메시지를 보여줌
	function showMessage(message) {
	    let chatbox = document.getElementById("chatbox");
	    let newMessage = document.createElement("div");
	    if(message.userNo === Number("[[${userNo}]]")){
	    	// 나
	    	newMessage.classList.add('message_right');
	    }else{
	    	// 상대방
	    	newMessage.classList.add('message_left');
	    }
	    //채팅 프로필 이미지
	    let img = document.createElement("img");
	    img.classList.add("chat_profil_img");
	    img.src="https://via.placeholder.com/40";
	    newMessage.appendChild(img);
	    //메시지 덩어리
	    let content = document.createElement("div");
	    content.classList.add('message_content');
	    //닉네임
	    let uname = document.createElement("span");
	    uname.classList.add('username');
	    uname.textContent = message.nickName;
	    //시간
	    let totime = document.createElement("span");
	    totime.classList.add('sendtime');
	    totime.textContent = message.forMatTime;
	    //내용
	    let texts = document.createElement("div");
	    texts.classList.add('text');
	    texts.textContent = message.msgContent;
	    
	    content.appendChild(uname);
	    content.appendChild(totime);
	    content.appendChild(texts);
	    newMessage.appendChild(content);
	    chatbox.appendChild(newMessage);
	    chatbox.scrollTop = chatbox.scrollHeight;
	}
	
	//채팅방 들어가기
	function enterRoom(event, roomId, roomType) {
		event.preventDefault();
	    currentRoomId = roomId;
	       
	    // 채팅방 UI 표시
	    $('#chatForm').show();
	    $('#roomName').text($(event.target).text());	// 채팅방 제목 바꿈
	    $('#chatbox').empty(); // 이전 메시지 초기화
	
	    // 소켓 연결중
	    if (stompClient !== null) {
	        stompClient.disconnect(function() {
	            connect(roomId , roomType);
	            loadMessage(roomId);
	        });
	    // 소켓 처음 연결
	    } else {
	        connect(roomId, roomType);
	        loadMessage(roomId);
	    }
	}
	// 채팅방 로드
	function loadRoom(){
		$.ajax({
			url: "/chatRoom/chatList",
			method: "GET",
			success: function(result){
				$('.chat-room-list').empty();
				result.forEach(function(list){
					showRoom(list);
				});
			},
			error: function(error){
				console.log(error);
			}
		})
	}
	function showRoom(list){
		let tagli = $('<li />');
		let tagA = $('<a />').prop('href','#').text(list.chatName);
		tagA.on('click', function(event){
			enterRoom(event,list.chatNo)
		});
		tagli.append(tagA);
		if(list.chatType == 'O1'){
			$('.chat-room-list.private').append(tagli);			
		}else if(list.chatType == 'O2'){
			$('.chat-room-list.group').append(tagli);
		}
	}
	
	// 이전 메시지 로드
	function loadMessage(roomId){
		$.ajax({
	    	url: "/chatRoom/logs",
	    	method: "POST",
	    	data: {roomId},
	    	success: function(result){
	    		result.forEach(function(message){
	    			showMessage(message);
	    		});
	    	},
	    	error: function(error){
	    		
	    	}
	    });
	}
	
	//아이콘 기능 모음
	//채팅홈
	
	//채팅방 팔로우 목록
	loadFollow();
	function loadFollow(){
		$.ajax({
			url: "/chatRoom/follow",
			method: "GET",
			success: function(result){
				result.forEach(function(follow){
					showFollow(follow);
				})
				$('#followPrivateBtn').on('click', insertPrivate);
				$('#followGroupBtn').on('click', insertGroup);
			},
			error: function(error){
				console.log(error);	
			}
		});
	}
	//채팅방 모달 
	function showFollow(follow){
		let label1 = $('<label />').prop('for','private_'+follow.followingId).addClass('follow-item');
		let span1 = $('<span />')
		let pro_img1 = $('<img />').prop('src','https://via.placeholder.com/40').addClass('profil_img');
		span1.append(pro_img1, follow.nickName);

		let radio = $('<input />').prop('type','radio')
		                          .addClass('select-follow')
		                          .attr('name','follow')
		                          .attr('id','private_'+follow.followingId)
		                          .val(follow.followingId);
		
		label1.append(span1,radio);
		$('#followListPrivate').append(label1);
		
		let label2 = $('<label />').prop('for','group_'+follow.followingId).addClass('follow-item');
		let span2 = $('<span />')
		let pro_img2 = $('<img />').prop('src','https://via.placeholder.com/40').addClass('profil_img');
		span2.append(pro_img2, follow.nickName);
		let checkbox = $('<input />').prop('type','checkbox')
		                             .addClass('select-follow')
		                             .attr('name','follow')
		                             .attr('id','group_'+follow.followingId)
		                             .val(follow.followingId);
		label2.append(span2, checkbox);
		$('#followListGroup').append(label2);
	}
	
	
	//채팅방 모달 on/off
	$('.bi-plus-circle').on('click', function(){
	    $('#chatModal').show();
	    $('#modalOverlay').show();
	})
	$('#privateChat').on('click', function(){
		$('#chatModal').hide();
		$('#privateChatModal').show();
		//$('#followListPrivate').empty();
		
	});
	$('#groupChat').on('click', function(){
		$('#chatModal').hide();
		$('#groupChatModal').show();
		//$('#followListGroup').empty();
		
	});
	function allClose(){
		$('#chatModal').hide();
		$('#privateChatModal').hide();
		$('#groupChatModal').hide();
		$('#modalOverlay').hide();
		$('.select-follow').prop("checked",false);
	}
	$('.modal-close').on('click', function() {
		allClose();
		$('#privateChatModal .input-field').val('');
		$('#inviteUsernames').val('');
	});
	$(window).click(function(event) {
	    if ($(event.target).is($('.modal'))) {
	    	allClose();
	    	$('#privateChatModal .input-field').val('');
	    	$('#inviteUsernames').val('');
	    }
	});
	

	// 1대1 채팅방 만들기
	function insertPrivate(){
		let process = null;
		let formObj = {};
		formObj['userNo'] = [];
		formObj['userName'] = [];
		formObj['chatType'] = 'O1';
		let checkName = null;
		$('#followListPrivate .select-follow').each(function() {
			if($(this).is(":checked")){
				formObj['chatName'] = "[[${nickname}]]" + '-' + $(this).prev().text();
				checkName = $(this).prev().text(); 
				formObj['userNo'].push(Number($(this).val()));
				formObj['userName'].push($(this).prev().text());
			}
		});
		if($('.chat-room-list.private li a').length > 0){
			$('.chat-room-list.private li a').each(function() {
				if($(this).text() == checkName){
					process = $(this);
				}
				//insertChatRoom(formObj);
			});			
			if(!process){
				insertChatRoom(formObj);
			}else{
				allClose();
				process.get(0).click();
			};
		}else{
			insertChatRoom(formObj);
		}
	}
	 
	// 그룹 채팅방 만들기
	function insertGroup(){
		let formObj = {};
		let chatName = $('#groupChatname').val();
		formObj['chatName'] = chatName;
		formObj['userNo'] = [];
		formObj['userName'] = [];
		formObj['chatType'] = 'O2';
		$('#followListGroup .select-follow').each(function() {
			if($(this).is(":checked")){
				formObj['userNo'].push(Number($(this).val()));
				formObj['userName'].push($(this).prev().text());
			}
		});
		
		insertChatRoom(formObj);
	}
	// 채팅 만들기 함수
	function insertChatRoom(formObj){
		$.ajax({
			url: '/chatRoom/CreateChat',
			method: 'POST',
			data : JSON.stringify(formObj),
			contentType: 'application/json',
			success: function(result){
				allClose();
				stompClient.send("/app/update.chatList", {}, JSON.stringify(result));			
			},
			error: function(error){
				console.log(error);
			}
		}); 
	}
	// 채팅방 나가기
	function leaveRoom(chatNo){
		if(confirm("나가겠습니까?")){
			stompClient.send("/app/chat.exit", {}, JSON.stringify({chatNo}));
		}
	}
	// 채팅방 수정(그룹채팅만)
	
	// 소켓 연결
	window.onload = function() {
		connect('@me');
	};
	//오픈채팅 만들기
	
	//오픈채팅 검색
</script>
</body>
</html>