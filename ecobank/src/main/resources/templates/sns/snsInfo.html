<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/sns_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<style>
.menu{
	text-align: right;
}

.a {
	text-decoration: none;
	color: #333;
}

.dropdown-menu {
	width: 20rem;
	padding: .5rem;
	background: #eee;
	z-index: 1;
	box-shadow: .3rem .3rem .5rem rgba(0, 0, 0, .3);
	display: none; /* 추가 */
}

.dropdown-menu a {
	display: block;
	transition: .3s;
}

.dropdown-menu a:hover {
	background-color: #ccc;
}

.dropdown-menu a i {
	margin-right: .5rem;
}
   /*모달*/
.modal {
	display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5); 
}
   
.modal_body {
	background-color: #ffffff;
    margin: 15% auto;
    padding: 20px;
    border-radius: 10px;
    width: 400px;
    color: #333; 
    text-align: center;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
}

/* reset */
ul{
    margin: 0;
    padding: 0;
}

/* design */

.selectbox{
    margin: 150px auto;
}

.pl{
	width: 200px;
	border: 1px solid #C4C4C4;
	box-sizing: border-box;
	border-radius: 10px;
	padding: 12px 13px;
	font-family: 'Roboto';
	font-style: normal;
	font-weight: 400;
	font-size: 14px;
	line-height: 16px;
	background: url(./img/Polygon_up.png) 93% no-repeat; /*화살표 이미지 삽입*/
	appearance: none;
	text-align: left;
}
.pl:focus{
    border: 1px solid #9B51E0;
    box-sizing: border-box;
    border-radius: 10px;
    outline: 3px solid #F8E4FF;
    border-radius: 10px;
}

.listbox{
    width: 200px;
    list-style: none;
    background: #FFFFFF;
    border: 1px solid #C4C4C4;
    box-sizing: border-box;
    box-shadow: 4px 4px 14px rgba(0, 0, 0, 0.15);
    border-radius: 10px;
    margin-top: 9px;
}

.list{
    border: none;
    background-color: #FFFFFF;
    font-family: 'Roboto';
    font-style: normal;
    font-weight: 400;
    font-size: 14px;
    line-height: 16px;
    padding: 7px 10px;
    margin: 5px 7px;
    box-sizing: border-box;
}

.list:focus{
    background: #F8E4FF;
    width: 184px;
    border-radius: 8px;
    box-sizing: border-box;
    text-align: left;
}

.radioBtn{
opacity : 0;
}

.radioBtn>label{
padding: 5px 10px;
border:1px solid #ccc;
border-radius:3px;
}

input[type=radio]:checked + label{
background: #ccc;
color:white;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"> </script>
</head>
<body>
	<h3>sns 상세보기</h3>
	<!-- Quote Start -->
	<form action="uploadForm" method="post" enctype="multipart/form-data">
		<div class="container-fluid bg-light overflow-hidden px-lg-0"
			style="margin: 6rem 0;">
			<div class="container quote px-lg-0">
				<div class="row g-0 mx-lg-0">
					<div class="col-lg-6 ps-lg-0 wow fadeIn" data-wow-delay="0.1s"
						style="min-height: 500px;">
						<div class="position-relative h-100">
							<div th:block th:each="file, sts : ${snsFileInfo}">
								<img class="position-absolute img-fluid w-100 h-100"
									th:src=@{/images/{fileName}(fileName=${file.fileName})}
									style="object-fit: cover;">
							</div>
						</div>
					</div>
					<div class="col-lg-6 quote-text py-5 wow fadeIn"
						data-wow-delay="0.5s"
						style="visibility: visible; animation-delay: 0.5s; animation-name: fadeIn;">
						<div class="p-lg-5 pe-lg-0">
							<div>
								<input type="number" th:value="${sns.feedNo}" hidden>
							</div>
							<div class="ml-3 info">
								<a href="#" th:text=${sns.nickname}></a>
								<button class="btn btn-primary">팔로우</button>
								<div class="menu">
									<a href="#" class="nav-menu">...</a>
									<div class="dropdown-menu">
										<a href="#" id="declareModal">게시글 신고하기</a> 
										<a th:href="@{/sns}">수정하기</a> 
										<a href='#' id="deleteA">삭제하기</a>
									</div>
								</div>
							</div>
							<p class="mb-4 pb-2" th:text="${sns.feedContent}"></p>
							<p class="mb-4 pb-2" th:text="${#dates.format(sns.feedCreateAt,'yyyy-MM-dd')}"></p>
							<div class="row g-3">
								<div class="col-12">
									<textarea class="form-control border-0" placeholder="Special Note"></textarea>
								</div>
								<span>좋아요 수 <a href="#" th:text=${sns.countLike}></a></span>
								<span>댓글 수 <a href="#" th:text=${sns.countReply}></a>
								</span>
							</div>
						</div>
					</div>
					<div class="col-12">
						<textarea class="form-control border-0" placeholder="댓글작성"></textarea>
					</div>
				</div>
			</div>
		</div>
	</form>
	<!-- Quote End -->

	<div>
		<button class="btn btn-primary" type="button"
			th:onclick="|location.href='@{/snsUpdate(feedNo=${sns.feedNo})}'|">수정</button>
		<button class="btn btn-primary" type="button"
			th:onclick="|location.href='@{/sns}'|">목록</button>
	</div>

	<!-- 댓글영역 -->
	<div id="replyWrite">
		<input type="hidden" th:value="${sns.feedNo}" id="feedNo" />
		<textarea rows="1" cols="30" th:text="${replyContent}" id="replyContent"></textarea>
		<button id="writeBtn" class="btn btn-primary">입력</button>
	</div>

	<div id="replyArea"></div>

	<!-- 모달영역 -->
 	<div class="modal">
        <div class="modal_body">
            <h4>피드 신고하기</h4>
            <form method="post">
					<th:block th:each="declare, sts : ${snsDeclare}">
				<input name="aaa" type='radio' class='radioBtn' th:value="${declare.codeId}" th:id="${declare.codeId}"/>
				<label  th:text="${declare.snsdeclare}" th:for="${declare.codeId}"></label> 
					</th:block>
			</form>
          <button type="button"  class="btn btn-primary" id="btn-close" aria-label="Close">신고하기</button>
          <button type="button"  class="btn btn-primary" id="btn-close" aria-label="Close">닫기</button>
        </div>
    </div>

<script th:inline="javascript">
	let feedNo = $('#feedNo').val();
	let rno = $('#replyNo').val();
	let replyContent = $('#replyContent');
	let userNo = [[${session.userNo}]];
	
	//게시글 삭제
	$('#deleteA').on('click', function(){
		if(confirm("정말 삭제하시겠습니까 ?") == true){   
			$.ajax({
				 url:"snsDelete?feedNo="+feedNo,
				 type: 'GET',
				 success: function(result) {
					 console.log(result);
		    	  	 alert("삭제되었습니다");
		    	  	 location.href="sns";
				 },
				  error: function(error) {
					  console.log(error);
				       alert('삭제가 실패되었습니다');
				  }
			});	
		}
	});

	$('.nav-menu').on('click',function(){
		$('.dropdown-menu').show();
	})		
	// ajax로 댓글 불러오기
	reply();
	function reply(){
		$.ajax({
			type : "GET",
			url : "snsReply?feedNo="+feedNo ,
			dataType : "json",
			success : function(list){
				console.log('getcon',replyContent);
				console.log(list,'ㅇㅇㅇ');
				replyList(list);
			},
			error :  function(){
				alert("댓글 불러오기 통신 실패");
			}
		});
	}
	
	// 댓글 입력(writeBtn) 버튼을 클릭할 경우
	$('#writeBtn').click(function(){
		let replyContent = $('#replyContent').val();
		let fno = $('#feedNo').val();

		// ajax로  등록하기
		$.ajax({
			type : "POST",
			url : "snsReply",
			data : {feedNo, replyContent,userNo},
			dataType : "json",
			success : function(list){

				$('#replyContent').val(""); //초기화
				reply();
			},
			error :  function(){
				alert("댓글 작성 통신 실패");
			}
		});
	});
	//리뷰 삭제
	function deleteBtn(rno){
		$.ajax({
			 url:"snsReply?replyNo="+rno,
			 type: 'delete',
			 data: {"replyNo" : rno},
			 success: function(result) {
			     	  	 alert("댓글이 삭제되었습니다");
			        	 location.reload();
			        	},
			  error: function() {
			          	alert('댓글 삭제가 실패되었습니다');
			          	}
		});	
				
	};
	
	function replyList(list){	
		let output = "";
		
		for(let i in list){
			output += "<tr>";
			//output += "<td>" + list[i].userNo+"</td>";
			console.log('닉네임을 찾자',list);
			output += "<td>" + list[i].nickname+"</td>";
			output += "<td>" + list[i].replyContent+"</td>";
			output += "<td>" + list[i].replyCreateAt+"</td>";
			output += `<td>
							<div class="menu">
							<a href="#" class="nav-menu">...</a>
							<div class="dropdown-menu">
								<a href="#" id="declareModal">댓글 신고하기</a> 
								<a href='#' id="deleteA">삭제하기</a>
							</div>
							</div>
						</td>`;

			output += "<td><button onclick='deleteBtn("+list[i].replyNo+")'>삭제</button></td>";

			output += "</tr>";
		}

		output += "</table>";
		$('#replyArea').html(output);
	}
	
	//모달
	  const modal = document.querySelector('.modal');
      const btnOpenModal=document.querySelector('.declareModal');

	$('#declareModal').on('click', function(){
		 modal.style.display="block";
		
	});
	

	$('#btn-close').on('click', function(){
		 modal.style.display="none";
		
	});
	

	
</script>
</body>

</html>