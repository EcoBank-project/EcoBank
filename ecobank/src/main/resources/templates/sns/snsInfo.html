<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
		xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  	layout:decorate="~{common/layouts/sns_layout}"
	  	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src ="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"> </script> 
</head>
<body>

	<h3>sns 상세보기</h3>
	
	    <!-- Quote Start -->
    <div class="container-fluid bg-light overflow-hidden px-lg-0" style="margin: 6rem 0;">
        <div class="container quote px-lg-0">
            <div class="row g-0 mx-lg-0">
                <div class="col-lg-6 ps-lg-0 wow fadeIn" data-wow-delay="0.1s" style="min-height: 1000px;">
                	<div class="author mb-4 d-flex align-items-center">
							<a href="#" class="img"
								style="background-image: url(images/person_2.jpg);"></a>
							<div class="ml-3 info">
								<a href="#" th:text=${sns.nickname}></a>
							</div>
							<button class="btn btn-primary">팔로우</button>
						</div>
                    <div class="position-relative h-100">
                    	<div th:block th:each="file, sts : ${snsFileInfo}">
                       		<img class="position-absolute img-fluid w-100 h-50" src=@{/images/{fileName}(fileName=${file.filePath})} style="object-fit: cover;" alt="">
                    	</div>	
                    </div>
                </div>
                <div class="col-lg-6 quote-text py-5 wow fadeIn" data-wow-delay="0.5s">
                    <div class="p-lg-5 pe-lg-0">
                        <h6 class="text-primary">Free Quote</h6>
                        <h1 class="mb-4">Get A Free Quote</h1>
                        <p class="mb-4 pb-2" th:text="${sns.feedContent}" ></p>
                        <p class="mb-4 pb-2" th:text="${#dates.format(sns.feedCreateAt,'yyyy-MM-dd')}"></p>
                        <form>
                            <div class="row g-3">
                                <div class="col-12">
                                    <textarea class="form-control border-0" placeholder="Special Note"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            	  <div class="col-12">
                                    <textarea class="form-control border-0" placeholder="댓글작성"></textarea>
                                </div>
            
            
            
        </div>
    </div>
    <!-- Quote End -->

	<form  action="uploadForm" method="post"
					enctype="multipart/form-data">
		<div>
			<label>번호</label>
			<input type="number" th:value="${sns.feedNo}" readonly>
		</div>
		<div>
		<input type="text" th:value="${sns.userNo}" hidden>
			<label>작성자</label>
			<input type="text" th:value="${sns.nickname}" readonly>
		</div>
			


 		<div class="post-content-entry">
				<div class="meta">
						<span>좋아요 수 <a href="#" th:text=${sns.countLike}></a></span>
						<span>댓글 수 <a href="#" th:text=${sns.countReply}></a></span>
					</div>
		</div>
		<div>
			<button class="btn btn-primary" type="button" th:onclick="|location.href='@{/snsUpdate(feedNo=${sns.feedNo})}'|">수정</button>
			<button class="btn btn-primary" type="button" th:onclick="|location.href='@{/sns}'|">목록</button>
			<button class="btn btn-primary" type="button" th:onclick="|location.href='@{/snsDelete(feedNo=${sns.feedNo})}'|">삭제</button>
		</div>
		</form>
		<!-- 댓글영역 -->
		<div id="replyWrite">
		<input type="hidden" th:value="${sns.feedNo}" id="feedNo" /> 

<!-- 		<input type="hidden"  name="userNo" /> -->
		<textarea rows="1" cols="30" th:text="${replyContent}" id="replyContent"></textarea>
		<button id="writeBtn" class="btn btn-primary">입력</button>
	</div>

	<div id="replyArea">

	</div>
	
	<script th:inline="javascript">
	// ajax로 댓글 불러오기
	let feedNo = $('#feedNo').val();
	let rno = $('#replyNo').val();
	let replyContent = $('#replyContent');
	let userNo = [[${session.userNo}]];
	reply();
	function reply(){
		$.ajax({
			type : "GET",
			url : "snsReply?feedNo="+feedNo ,
			dataType : "json",
			success : function(list){
				console.log('getcon',replyContent);
				console.log(list,'ㅇㅇㅇ');
				replyList(list);
			},
			error :  function(){
				alert("댓글 불러오기 통신 실패");
			}
		});
	}
	
	// 댓글 입력(writeBtn) 버튼을 클릭할 경우
	$('#writeBtn').click(function(){
		let replyContent = $('#replyContent').val();
		let fno = $('#feedNo').val();

		// ajax로  등록하기
		$.ajax({
			type : "POST",
			url : "snsReply",
			data : {feedNo, replyContent,userNo},
			dataType : "json",
			success : function(list){

				$('#replyContent').val(""); //초기화
				reply();
			},
			error :  function(){
				alert("댓글 작성 통신 실패");
			}
		});
	});
	//리뷰 삭제
	function deleteBtn(rno){
		$.ajax({
			 url:"snsReply?replyNo="+rno,
			 type: 'delete',
			 data: {"replyNo" : rno},
			 success: function(result) {
			     	  	 alert("댓글이 삭제되었습니다");
			        	 location.reload();
			        	},
			  error: function() {
			          	alert('댓글 삭제가 실패되었습니다');
			          	}
		});	
				
	};
	
	function replyList(list){	
		let output = "";
		
		for(let i in list){
			output += "<tr>";
			//output += "<td>" + list[i].userNo+"</td>";
			console.log('닉네임을 찾자',list);
			output += "<td>" + list[i].nickname+"</td>";
			output += "<td>" + list[i].replyContent+"</td>";
			output += "<td>" + list[i].replyCreateAt+"</td>";
			output += "<td><button onclick='deleteBtn("+list[i].replyNo+")'>삭제</button></td>";

			output += "</tr>";
		}

		output += "</table>";
		$('#replyArea').html(output);
	}
	
	</script>
</body>

</html>