<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ecobank.app.mypage.mapper.MypageChallMapper">
	<select id="getChallengeInfo" parameterType="int" resultType="MypageChallVO">
    WITH RankedChallenges AS (
        SELECT c.chall_no,
               c.chall_title,
               c.chall_content,
               c.chall_startAt,
               c.chall_closeAt,
               ce.chall_enterat,
               c.chall_state,
               c.main_img,
               ce.user_no,
               cc.confirm_no,
               ROUND(COUNT(cc.confirm_no) / 
                     (TRUNC(c.chall_closeAt) - TRUNC(ce.chall_enterat)), 2) * 100 AS progressRate,
               ROW_NUMBER() OVER (PARTITION BY c.chall_no ORDER BY c.chall_startAt) AS rn
        FROM chall c
        JOIN chall_enter ce ON c.chall_no = ce.chall_no
        JOIN chall_confirm cc ON cc.user_no = ce.user_no
        WHERE c.chall_state = 'D2'
        AND ce.user_no = #{userNo}
        GROUP BY c.chall_no,
                 c.chall_title,
                 c.chall_content,
                 c.chall_startAt,
                 c.chall_closeAt,
                 ce.chall_enterat,
                 c.chall_state,
                 c.main_img,
                 ce.user_no,
                 cc.confirm_no
    )
    SELECT *
    FROM RankedChallenges
    WHERE rn = 1
	</select>
</mapper>